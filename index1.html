<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HÆ°á»›ng Nghiá»‡p AI</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:system-ui,sans-serif;background:#080a10;color:#e2e6f3;height:100vh;display:flex;flex-direction:column;overflow:hidden}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:#232a3a;border-radius:2px}
.header{background:#0f1219;border-bottom:1px solid #232a3a;padding:10px 16px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.header-left{display:flex;align-items:center;gap:10px}
.avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#9b8bff,#5544cc);display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:0 0 14px rgba(124,106,255,.45);flex-shrink:0}
.brand{font-size:15px;font-weight:800;background:linear-gradient(135deg,#a899ff,#ff90b8);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
.brand-sub{font-size:8.5px;color:#60698a;letter-spacing:1.2px;text-transform:uppercase}
.online{display:flex;align-items:center;gap:6px;background:rgba(61,255,168,.07);border:1px solid rgba(61,255,168,.2);border-radius:20px;padding:4px 12px;font-size:10.5px;color:#3dffa8;font-weight:600}
.dot{width:6px;height:6px;border-radius:50%;background:#3dffa8;animation:pulse 2s infinite;display:inline-block}
.main{flex:1;display:flex;overflow:hidden}
.sidebar{width:380px;border-right:1px solid #232a3a;display:flex;flex-direction:column;overflow:hidden;flex-shrink:0}
.tabs{display:flex;background:#0f1219;border-bottom:1px solid #232a3a;flex-shrink:0}
.tab{flex:1;padding:10px 0;background:none;border:none;border-bottom:2px solid transparent;color:#60698a;font-size:11.5px;cursor:pointer;transition:.2s;font-family:inherit}
.tab.active{border-bottom-color:#7c6aff;color:#7c6aff;font-weight:700}
.dash{flex:1;overflow-y:auto;padding:14px}
.block{background:#0f1219;border:1px solid #232a3a;border-radius:14px;padding:14px;margin-bottom:12px;position:relative;overflow:hidden}
.block::before{content:"";position:absolute;top:0;left:0;right:0;height:2.5px;background:var(--stripe);border-radius:14px 14px 0 0}
.block-title{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#60698a;font-weight:600;margin-bottom:12px}
.info-row{display:flex;gap:7px;margin-bottom:10px}
.card{background:#161b27;border:1px solid #232a3a;border-radius:10px;padding:9px 11px;flex:1;min-width:0}
.card-label{font-size:8px;color:#60698a;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
.card-val{font-size:12px;font-weight:600;word-break:break-word;color:#e2e6f3}
.pills{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px}
.pill{padding:3px 10px;border-radius:20px;font-size:11px;font-weight:500;display:inline-block}
.pill-high{background:rgba(124,106,255,.16);border:1px solid rgba(124,106,255,.45);color:#b0a4ff}
.pill-mid{background:rgba(255,95,141,.12);border:1px solid rgba(255,95,141,.38);color:#ff8fb0}
.pill-low{background:rgba(46,54,80,.4);border:1px solid #232a3a;color:#60698a}
.insight-box{background:linear-gradient(135deg,rgba(124,106,255,.1),rgba(255,95,141,.07));border:1px solid rgba(124,106,255,.3);border-radius:10px;padding:11px 13px;font-size:12.5px;line-height:1.65;font-style:italic;color:#e2e6f3}
.insight-empty{background:rgba(124,106,255,.05);border:1px dashed #232a3a;border-radius:10px;padding:10px 13px;font-size:11px;color:#2e3650;font-style:italic}
.pbar-wrap{margin-bottom:10px}
.pbar-top{display:flex;justify-content:space-between;font-size:10px;color:#60698a;margin-bottom:4px}
.pbar{height:5px;background:#232a3a;border-radius:3px;overflow:hidden}
.pbar-fill{height:100%;border-radius:3px;transition:width 1.1s ease}
.road-section{background:#161b27;border:1px solid #232a3a;border-radius:10px;padding:10px 12px;margin-bottom:8px}
.road-label{font-size:9px;text-transform:uppercase;letter-spacing:1.5px;font-weight:700;margin-bottom:8px}
.road-item{font-size:12px;padding:2px 0 2px 14px;position:relative;line-height:1.5;color:#e2e6f3}
.road-item::before{content:"â†’";position:absolute;left:0;font-size:10px;font-weight:700}
.countdown{display:flex;gap:7px}
.cd{flex:1;background:#0f1219;border:1px solid #232a3a;border-radius:10px;padding:8px 5px;text-align:center}
.cd-num{font-size:20px;font-weight:800;line-height:1;font-variant-numeric:tabular-nums}
.cd-lbl{font-size:8px;color:#60698a;margin-top:4px;text-transform:uppercase;letter-spacing:1px}
.chat-area{flex:1;display:flex;flex-direction:column;overflow:hidden}
.chat-header{padding:11px 16px;border-bottom:1px solid #232a3a;display:flex;align-items:center;gap:10px;flex-shrink:0;background:#0f1219}
.chat-box{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:12px}
.msg{max-width:80%;padding:10px 14px;border-radius:16px;font-size:13.5px;line-height:1.7;word-break:break-word;animation:slideIn .2s ease}
.msg.user{align-self:flex-end;background:linear-gradient(135deg,#4285F4,#2a60c0);color:#fff;border-radius:16px 16px 5px 16px}
.msg.ai{align-self:flex-start;background:#161b27;border:1px solid #232a3a;border-radius:16px 16px 16px 5px}
.msg-time{font-size:9.5px;color:#2e3650;margin-top:4px;padding:0 4px}
.suggestions{padding:7px 12px 0;display:flex;flex-wrap:wrap;gap:5px;border-top:1px solid #232a3a;flex-shrink:0}
.sug-btn{background:#161b27;border:1px solid #232a3a;color:#60698a;border-radius:20px;padding:5px 13px;font-size:11px;cursor:pointer;font-family:inherit;transition:.18s}
.sug-btn:hover{border-color:#7c6aff;color:#a89fff}
.input-row{padding:8px 12px 12px;display:flex;gap:8px;align-items:flex-end;flex-shrink:0}
.chat-input{flex:1;background:#161b27;border:1px solid #2e3850;border-radius:14px;padding:9px 14px;color:#e2e6f3;font-size:13px;font-family:inherit;resize:none;outline:none;height:41px;max-height:110px;line-height:1.55;transition:border-color .2s}
.chat-input:focus{border-color:#7c6aff}
.send-btn{width:41px;height:41px;background:linear-gradient(135deg,#4285F4,#2a60c0);border:none;border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:.17s}
.send-btn:hover{opacity:.85;transform:scale(1.06)}
.send-btn:disabled{opacity:.4;cursor:not-allowed;transform:none}
.error-bar{margin:6px 12px;background:rgba(255,77,109,.08);border:1px solid rgba(255,77,109,.3);border-radius:12px;padding:10px 14px;font-size:12px;color:#ff6b88;display:none}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.45;transform:scale(.72)}}
@keyframes bounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-7px)}}
@keyframes slideIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
@media(max-width:700px){.sidebar{display:none}.chat-area{flex:1}}
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <div class="avatar">ğŸ¤–</div>
    <div>
      <div class="brand">HÆ°á»›ng Nghiá»‡p AI</div>
      <div class="brand-sub">Powered by Gemini 2.5 Flash</div>
    </div>
  </div>
  <div class="online"><span class="dot"></span>Online</div>
</div>

<div class="main">
  <div class="sidebar">
    <div class="tabs">
      <button class="tab active" onclick="switchTab('dash')">ğŸ“Š Dashboard</button>
      <button class="tab" onclick="switchTab('help')">ğŸ›  Há»— trá»£</button>
    </div>

    <div id="tab-dash" class="dash">
      <div class="block" style="--stripe:linear-gradient(90deg,#7c6aff,#ff5f8d)">
        <div class="block-title">ğŸ§  Tráº¡ng thÃ¡i cáº£m xÃºc</div>
        <div class="info-row">
          <div class="card"><div class="card-label">ğŸ’­ TÃ¢m tráº¡ng</div><div class="card-val" id="d-mood">Äang láº¯ng ngheâ€¦</div></div>
          <div class="card"><div class="card-label">ğŸ˜Ÿ Ná»—i sá»£</div><div class="card-val" id="d-fear">â€”</div></div>
          <div class="card"><div class="card-label">ğŸŒ± Gá»‘c rá»…</div><div class="card-val" id="d-root">â€”</div></div>
        </div>
        <div id="d-insight" class="insight-empty">Tiáº¿p tá»¥c chia sáº» Ä‘á»ƒ mÃ¬nh váº½ chÃ¢n dung tÃ­nh cÃ¡ch cá»§a báº¡nâ€¦</div>
      </div>

      <div class="block" style="--stripe:linear-gradient(90deg,#ff5f8d,#ffbe3d)">
        <div class="block-title">ğŸ” Há»“ sÆ¡ ná»™i tÃ¢m</div>
        <div class="pbar-wrap"><div class="pbar-top"><span>GiÃ¡ trá»‹ sá»‘ng</span><span id="pct-val">0%</span></div><div class="pbar"><div class="pbar-fill" id="fill-val" style="width:0%;background:#7c6aff"></div></div></div>
        <div class="pbar-wrap"><div class="pbar-top"><span>Kiá»ƒu lÃ m viá»‡c</span><span id="pct-work">0%</span></div><div class="pbar"><div class="pbar-fill" id="fill-work" style="width:0%;background:#ff5f8d"></div></div></div>
        <div class="pbar-wrap"><div class="pbar-top"><span>Äá»™ng lá»±c sá»‘ng</span><span id="pct-mot">0%</span></div><div class="pbar"><div class="pbar-fill" id="fill-mot" style="width:0%;background:#3dffa8"></div></div></div>
        <div style="margin-top:8px"><div style="font-size:10px;color:#60698a;margin-bottom:5px">ğŸ”¹ GiÃ¡ trá»‹ sá»‘ng</div><div class="pills" id="d-vals"><span class="pill pill-low">Chá» phÃ¢n tÃ­châ€¦</span></div></div>
        <div style="margin-top:8px"><div style="font-size:10px;color:#60698a;margin-bottom:5px">ğŸ”¹ Kiá»ƒu lÃ m viá»‡c</div><div class="pills" id="d-work"><span class="pill pill-low">Chá» phÃ¢n tÃ­châ€¦</span></div></div>
        <div style="margin-top:8px"><div style="font-size:10px;color:#60698a;margin-bottom:5px">ğŸ”¹ Äá»™ng lá»±c</div><div class="pills" id="d-mot"><span class="pill pill-low">Chá» phÃ¢n tÃ­châ€¦</span></div></div>
      </div>

      <div class="block" style="--stripe:linear-gradient(90deg,#ffbe3d,#3dffa8)">
        <div class="block-title">ğŸ“ Chiáº¿n lÆ°á»£c thi Ä‘áº¡i há»c</div>
        <div class="info-row">
          <div class="card"><div class="card-label">ğŸ¯ Má»¥c tiÃªu</div><div class="card-val" id="d-uni-t">â€”</div></div>
          <div class="card"><div class="card-label">ğŸ›¡ An toÃ n</div><div class="card-val" id="d-uni-s">â€”</div></div>
          <div class="card"><div class="card-label">ğŸ”„ Dá»± phÃ²ng</div><div class="card-val" id="d-uni-b">â€”</div></div>
        </div>
        <div style="background:rgba(255,190,61,.07);border:1px solid rgba(255,190,61,.22);border-radius:10px;padding:10px 13px">
          <div style="font-size:9px;color:#ffbe3d;text-transform:uppercase;letter-spacing:1.4px;font-weight:700;margin-bottom:8px">â± Äáº¿m ngÆ°á»£c THPT 2026 Â· 11/6/2026</div>
          <div class="countdown">
            <div class="cd"><div class="cd-num" id="cd-d" style="color:#ffbe3d">--</div><div class="cd-lbl">NgÃ y</div></div>
            <div class="cd"><div class="cd-num" id="cd-h" style="color:#7c6aff">--</div><div class="cd-lbl">Giá»</div></div>
            <div class="cd"><div class="cd-num" id="cd-m" style="color:#ff5f8d">--</div><div class="cd-lbl">PhÃºt</div></div>
            <div class="cd"><div class="cd-num" id="cd-s" style="color:#3dffa8">--</div><div class="cd-lbl">GiÃ¢y</div></div>
          </div>
        </div>
      </div>

      <div class="block" style="--stripe:linear-gradient(90deg,#7c6aff,#3dffa8)">
        <div class="block-title">ğŸš€ Lá»™ trÃ¬nh phÃ¡t triá»ƒn</div>
        <div class="road-section"><div class="road-label" style="color:#7c6aff">3 thÃ¡ng Ä‘áº§u</div><div id="d-r3"><div class="road-item">Ká»ƒ ngÃ nh báº¡n quan tÃ¢m Ä‘á»ƒ mÃ¬nh lÃªn lá»™ trÃ¬nh</div></div></div>
        <div class="road-section"><div class="road-label" style="color:#ffbe3d">6 thÃ¡ng</div><div id="d-r6"><div class="road-item">Lá»™ trÃ¬nh sáº½ cÃ¡ nhÃ¢n hÃ³a theo báº¡n</div></div></div>
        <div class="road-section" style="margin-bottom:0"><div class="road-label" style="color:#3dffa8">1 nÄƒm</div><div id="d-r1"><div class="road-item">Má»¥c tiÃªu dÃ i háº¡n cá»§a báº¡n</div></div></div>
      </div>
    </div>

    <div id="tab-help" class="dash" style="display:none">
      <div class="block" style="--stripe:linear-gradient(90deg,#7c6aff,#3dffa8)">
        <div class="block-title">â“ HÆ°á»›ng dáº«n sá»­ dá»¥ng</div>
        <div style="font-size:12.5px;color:#a0aabb;line-height:1.8">
          <p>ğŸ’¬ <strong style="color:#e2e6f3">Chat thoáº£i mÃ¡i</strong> â€” ká»ƒ vá» lo láº¯ng, Ä‘á»‹nh hÆ°á»›ng, hay Ä‘iá»ƒm sá»‘</p>
          <p style="margin-top:8px">ğŸ“Š <strong style="color:#e2e6f3">Dashboard</strong> tá»± Ä‘á»™ng cáº­p nháº­t khi AI phÃ¢n tÃ­ch Ä‘Æ°á»£c thÃ´ng tin</p>
          <p style="margin-top:8px">ğŸ”’ <strong style="color:#e2e6f3">RiÃªng tÆ°</strong> â€” khÃ´ng lÆ°u, khÃ´ng phÃ¡n xÃ©t</p>
          <p style="margin-top:8px">ğŸŒ <strong style="color:#e2e6f3">Server</strong> cháº¡y trÃªn Render.com</p>
        </div>
      </div>
      <div class="block" style="--stripe:linear-gradient(90deg,#ff5f8d,#ffbe3d)">
        <div class="block-title">âš™ï¸ TÃ¹y chá»n</div>
        <button onclick="resetChat()" style="background:linear-gradient(135deg,#ff5f8d,#c0305a);border:none;border-radius:10px;padding:10px 16px;color:#fff;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit">ğŸ”„ Báº¯t Ä‘áº§u phiÃªn má»›i</button>
      </div>
    </div>
  </div>

  <div class="chat-area">
    <div class="chat-header">
      <div class="avatar" style="width:38px;height:38px;font-size:20px">ğŸ¤–</div>
      <div>
        <div style="font-weight:700;font-size:13.5px">Mentor AI Â· Minh</div>
        <div style="font-size:10px;color:#3dffa8;display:flex;align-items:center;gap:5px;margin-top:1px"><span class="dot"></span>Online Â· Gemini 2.5 Flash</div>
      </div>
    </div>

    <div class="chat-box" id="chat-box">
      <div id="welcome" style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;padding:20px;text-align:center">
        <div style="font-size:36px">ğŸ‘‹</div>
        <div style="font-size:18px;font-weight:800;background:linear-gradient(135deg,#b0a4ff,#ff90b8);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent">Xin chÃ o! MÃ¬nh lÃ  Mentor AI</div>
        <div style="font-size:12.5px;color:#60698a;line-height:1.75">KhÃ´ng phÃ¡n xÃ©t Â· KhÃ´ng sÃ¡o rá»—ng<br/>Chá»‰ láº¯ng nghe vÃ  Ä‘á»“ng hÃ nh cÃ¹ng báº¡n ğŸ¤</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;width:100%;max-width:360px">
          <button class="sug-btn" style="border-radius:12px;padding:10px 12px;text-align:left;color:#e2e6f3" onclick="sendMsg('MÃ¬nh Ä‘ang ráº¥t lo vá» viá»‡c chá»n ngÃ nh, khÃ´ng biáº¿t nÃªn há»c gÃ¬')">ğŸ˜° Lo chá»n ngÃ nh</button>
          <button class="sug-btn" style="border-radius:12px;padding:10px 12px;text-align:left;color:#e2e6f3" onclick="sendMsg('Gia Ä‘Ã¬nh muá»‘n mÃ¬nh há»c ngÃ nh khÃ¡c, mÃ¬nh tháº¥y Ã¡p lá»±c láº¯m')">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Ãp lá»±c gia Ä‘Ã¬nh</button>
          <button class="sug-btn" style="border-radius:12px;padding:10px 12px;text-align:left;color:#e2e6f3" onclick="sendMsg('MÃ¬nh khÃ´ng biáº¿t mÃ¬nh thá»±c sá»± thÃ­ch gÃ¬ vÃ  giá»i gÃ¬ cáº£')">ğŸ¤” ChÆ°a biáº¿t thÃ­ch gÃ¬</button>
          <button class="sug-btn" style="border-radius:12px;padding:10px 12px;text-align:left;color:#e2e6f3" onclick="sendMsg('Äiá»ƒm mÃ¬nh chÆ°a Ä‘á»§ vÃ o trÆ°á»ng mÆ¡ Æ°á»›c, pháº£i lÃ m sao?')">ğŸ“‰ Lo Ä‘iá»ƒm thi</button>
        </div>
      </div>
    </div>

    <div id="error-bar" class="error-bar"></div>

    <div class="suggestions">
      <button class="sug-btn" onclick="sendMsg('MÃ¬nh Ä‘ang ráº¥t lo vá» viá»‡c chá»n ngÃ nh, khÃ´ng biáº¿t nÃªn há»c gÃ¬')">ğŸ˜° Lo chá»n ngÃ nh</button>
      <button class="sug-btn" onclick="sendMsg('Gia Ä‘Ã¬nh muá»‘n mÃ¬nh há»c ngÃ nh khÃ¡c, mÃ¬nh tháº¥y Ã¡p lá»±c láº¯m')">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Ãp lá»±c gia Ä‘Ã¬nh</button>
      <button class="sug-btn" onclick="sendMsg('MÃ¬nh khÃ´ng biáº¿t mÃ¬nh thá»±c sá»± thÃ­ch gÃ¬ vÃ  giá»i gÃ¬ cáº£')">ğŸ¤” ChÆ°a biáº¿t thÃ­ch gÃ¬</button>
      <button class="sug-btn" onclick="sendMsg('Äiá»ƒm mÃ¬nh chÆ°a Ä‘á»§ vÃ o trÆ°á»ng mÆ¡ Æ°á»›c, pháº£i lÃ m sao?')">ğŸ“‰ Lo Ä‘iá»ƒm thi</button>
    </div>

    <div class="input-row">
      <textarea id="chat-input" class="chat-input" placeholder="TÃ¢m sá»± thoáº£i mÃ¡i nhÃ©â€¦" rows="1"
        onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}"></textarea>
      <button class="send-btn" id="send-btn" onclick="sendChat()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
      </button>
    </div>
  </div>
</div>

<script>
const API = "https://chabot-huong-nghiep.onrender.com";
let chatHistory = [];
let busy = false;
let welcomeShown = true;

// â”€â”€ Countdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateCountdown() {
  const diff = new Date("2026-06-11T00:00:00") - new Date();
  if (diff <= 0) { ["cd-d","cd-h","cd-m","cd-s"].forEach(id => document.getElementById(id).textContent = "00"); return; }
  const pad = n => String(n).padStart(2,"0");
  document.getElementById("cd-d").textContent = pad(Math.floor(diff/864e5));
  document.getElementById("cd-h").textContent = pad(Math.floor((diff%864e5)/36e5));
  document.getElementById("cd-m").textContent = pad(Math.floor((diff%36e5)/6e4));
  document.getElementById("cd-s").textContent = pad(Math.floor((diff%6e4)/1e3));
}
updateCountdown();
setInterval(updateCountdown, 1000);

// â”€â”€ Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name) {
  document.querySelectorAll(".tab").forEach((t,i) => t.classList.toggle("active", ["dash","help"][i] === name));
  document.getElementById("tab-dash").style.display = name === "dash" ? "block" : "none";
  document.getElementById("tab-help").style.display = name === "help" ? "block" : "none";
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ts() { return new Date().toLocaleTimeString("vi-VN",{hour:"2-digit",minute:"2-digit"}); }

function clearWelcome() {
  if (!welcomeShown) return;
  document.getElementById("welcome")?.remove();
  welcomeShown = false;
}

function appendMsg(text, role) {
  clearWelcome();
  const box = document.getElementById("chat-box");
  const wrap = document.createElement("div");
  wrap.style.cssText = `display:flex;flex-direction:column;align-items:${role==="user"?"flex-end":"flex-start"}`;
  const msg = document.createElement("div");
  msg.className = "msg " + role;
  msg.textContent = text;
  const time = document.createElement("div");
  time.className = "msg-time";
  time.textContent = ts();
  wrap.appendChild(msg);
  wrap.appendChild(time);
  box.appendChild(wrap);
  box.scrollTop = box.scrollHeight;
  return msg;
}

function showError(msg) {
  const bar = document.getElementById("error-bar");
  bar.textContent = msg;
  bar.style.display = "block";
  setTimeout(() => bar.style.display = "none", 6000);
}

// â”€â”€ Parse JSON an toÃ n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function safeParseJSON(raw) {
  if (!raw) return null;
  // Thá»­ parse trá»±c tiáº¿p
  try { return JSON.parse(raw); } catch {}
  // Thá»­ tÃ¬m JSON trong string
  const s = raw.indexOf("{"), e = raw.lastIndexOf("}");
  if (s >= 0 && e > s) {
    try { return JSON.parse(raw.slice(s, e+1)); } catch {}
  }
  return null;
}

// â”€â”€ Send â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendMsg(text) { if (!busy) await doSend(text); }
async function sendChat() {
  const input = document.getElementById("chat-input");
  const text = input.value.trim();
  if (!text || busy) return;
  input.value = "";
  await doSend(text);
}

async function doSend(text) {
  busy = true;
  document.getElementById("send-btn").disabled = true;
  document.getElementById("error-bar").style.display = "none";

  appendMsg(text, "user");
  chatHistory.push({ role: "user", parts: [{ text }] });

  // Typing indicator
  clearWelcome();
  const box = document.getElementById("chat-box");
  const typingWrap = document.createElement("div");
  typingWrap.style.cssText = "display:flex;align-items:flex-start";
  const typing = document.createElement("div");
  typing.className = "msg ai";
  typing.style.opacity = ".6";
  typing.innerHTML = `<span style="display:flex;gap:5px;align-items:center">${[0,.18,.36].map(d=>`<span style="width:6px;height:6px;background:#60698a;border-radius:50%;display:block;animation:bounce 1.1s ${d}s infinite"></span>`).join("")}</span>`;
  typingWrap.appendChild(typing);
  box.appendChild(typingWrap);
  box.scrollTop = box.scrollHeight;

  try {
    const res = await fetch(API + "/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: text, history: chatHistory.slice(0,-1) }),
    });
    if (!res.ok) throw new Error("Server lá»—i: " + res.status);
    const data = await res.json();
    typingWrap.remove();

    const raw = data.reply || "";
    const parsed = safeParseJSON(raw);
    const msgText = parsed?.msg || raw.trim() || "MÃ¬nh nháº­n Ä‘Æ°á»£c rá»“i!";

    appendMsg(msgText, "ai");
    chatHistory.push({ role: "model", parts: [{ text: raw }] });
    if (parsed?.db) applyDB(parsed.db);

  } catch (e) {
    typingWrap.remove();
    showError(e instanceof TypeError
      ? "âš  KhÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c server. Server cÃ³ thá»ƒ Ä‘ang khá»Ÿi Ä‘á»™ng (~30s), thá»­ láº¡i nhÃ©!"
      : "âš  " + e.message);
  } finally {
    busy = false;
    document.getElementById("send-btn").disabled = false;
    document.getElementById("chat-input").focus();
  }
}

// â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyDB(db) {
  if (!db) return;
  if (db.mood) document.getElementById("d-mood").textContent = db.mood;
  if (db.fear) document.getElementById("d-fear").textContent = db.fear;
  if (db.root) document.getElementById("d-root").textContent = db.root;
  if (db.insight) {
    const el = document.getElementById("d-insight");
    el.className = "insight-box";
    el.textContent = `"${db.insight}"`;
  }
  if (db.values?.length)  renderPills("d-vals", db.values);
  if (db.work?.length)    renderPills("d-work", db.work);
  if (db.motive?.length)  renderPills("d-mot",  db.motive);

  setPbar("val",  Math.min(100, (db.values?.length||0)*20  + (db.insight?20:0)));
  setPbar("work", Math.min(100, (db.work?.length||0)*20    + (db.motive?.length||0)*15));
  setPbar("mot",  Math.min(100, (db.motive?.length||0)*25));

  if (db.uni?.target) document.getElementById("d-uni-t").textContent = db.uni.target;
  if (db.uni?.safe)   document.getElementById("d-uni-s").textContent = db.uni.safe;
  if (db.uni?.backup) document.getElementById("d-uni-b").textContent = db.uni.backup;

  if (db.road?.m3?.length) renderRoad("d-r3", db.road.m3, "#7c6aff");
  if (db.road?.m6?.length) renderRoad("d-r6", db.road.m6, "#ffbe3d");
  if (db.road?.y1?.length) renderRoad("d-r1", db.road.y1, "#3dffa8");
}

function renderPills(id, items) {
  document.getElementById(id).innerHTML = items.map(({l,v}) =>
    `<span class="pill pill-${v||'low'}">${l}</span>`).join("");
}
function setPbar(key, pct) {
  document.getElementById("fill-"+key).style.width = pct + "%";
  document.getElementById("pct-"+key).textContent = pct + "%";
}
function renderRoad(id, items, color) {
  document.getElementById(id).innerHTML = items.map(t =>
    `<div class="road-item" style="color:#e2e6f3">${t}</div>`).join("");
}

function resetChat() {
  chatHistory = []; welcomeShown = true;
  document.getElementById("chat-box").innerHTML = `
    <div id="welcome" style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;padding:20px;text-align:center">
      <div style="font-size:36px">ğŸ‘‹</div>
      <div style="font-size:18px;font-weight:800;background:linear-gradient(135deg,#b0a4ff,#ff90b8);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent">Xin chÃ o! MÃ¬nh lÃ  Mentor AI</div>
      <div style="font-size:12.5px;color:#60698a;line-height:1.75">KhÃ´ng phÃ¡n xÃ©t Â· KhÃ´ng sÃ¡o rá»—ng<br/>Chá»‰ láº¯ng nghe vÃ  Ä‘á»“ng hÃ nh cÃ¹ng báº¡n ğŸ¤</div>
    </div>`;
}
</script>
</body>
</html>